---
title: "React setState batching"
date: "2020-12-07T18:30:00.000Z"
description:
  "Testing lists could be bit tricky. Let's see how we can test it with React
  Testing Library."
---

We update a state, React updates the DOM. Reacting to the state changes is what
React is. DOM updates are expensive operations, they take a long time. So if
React updated everytime there is a state update our UI would be slugish. To over
come this, React batches these updates. Batching of states is usually refered as
`async`. It comes from the official docs
"[State Updates May Be Asynchronous](https://reactjs.org/docs/state-and-lifecycle.html#state-updates-may-be-asynchronous)".
React does this as performance optimization. Let's dive in.

Let's see what happens when we update a state.

https://codesandbox.io/s/react-batched-single-b1n2h?file=/src/App.js&view=split

Open up the logs, and click the counter. You would see a log `Rendering`
everytime you click. That is not surprising is it? Let's another `setState` in
the handler. How many times do think we would get `Rendering` this time?

https://codesandbox.io/s/react-batched-double-5qcp9?file=/src/App.js&view=split

It still gives you only one `Rendering` even though we are setting the state
twice. Yup, this is the performance optimization we were talking about. This
means no matter how many times we set the state in a single **tick**, React
would render only once.

How does the React know there is going to be a state update before React decides
to render? Let's add a debugger in our `increment` event handler.

--

That's interesting, we see `batchedEventUpdates` that is being called from
ReactDOM. If we look a bit into React's source code, we see ReactDOM exports
[unstable_batchedUpdates](https://github.com/facebook/react/blob/4c7036e807fa18a3e21a5182983c7c0f05c5936e/packages/react-dom/index.stable.js#L12)
to batch all the updates. And If we dig a little deeper, we see that it uses
Reconciler. Okay, you might be thinking that's a bunch of code. What do
understand from it? To be honest, I don't understand a lot either. But when we
poke a around a little, we get to know that React uses scheduler to time keep
the updates.

So somewhere in the Reacts code, it wrapping all the updates in a
`batchedUpdates`. This is possible for react to do, because React know the
handlers attached and it can wait for the "render" function to complete. It
could give React the states it needs to update for the next render. This also
means that everything outside that event loop (**the tick**), React wouldn't be
able to batch them.

To test that out, let's add an `async` handler and then `await` for something
then update the state.

https://codesandbox.io/s/react-batched-async-xw5xu?file=/src/App.js

We have two updates before an await and two after. If you click on the counter
now, you will three logs per click. That is because as mentioned before, React
can only batch updates if it knows before hand it has to update. Put an `await`
in the handler, set the update sometime in the future. Because of which React
can't batch updates. So any updates after the await, React your immediately
flush those updates and render again.

This is true for anything, updating the state outside React's "loop"
(scheduler). It could be `setTimeout`'s, `event handlers` (set directly to DOM
element) etc.

You can try all these cases in a single code sandbox.

https://codesandbox.io/s/react-dom-batched-updates-smerl?file=/src/App.js

> Original
> [demo](https://codesandbox.io/s/react-dom-batched-updates-6b61f?file=/src/App.js)
> was created by [Yago](https://twitter.com/yagopereiraaz)

We have these kind of fun conversion on [discord](https://discord.gg/GBeVchET).
Join us if you want to be part of it.

So how does this help us? Now we know that React render everytime a state update
is called after an async operations. We can avoid it. If multiple states are
related and they have to updated together, use
[useReducer](https://reactjs.org/docs/hooks-reference.html#usereducer) instead.

TL;DR;

React would batch your updates as long it happens in the same loop. State
updates after any async operation would make React to update the state
immediately (No batching).
